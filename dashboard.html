<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="¬© 2025 Justin A.F.D. Kozak">
    <meta name="license" content="MIT License">
    <title>Operations KPI Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
        }
        
        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: #3b82f6;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .file-info {
            margin-top: 15px;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-label {
            font-weight: 600;
            color: #475569;
        }
        
        .period-buttons {
            display: flex;
            gap: 10px;
        }
        
        .period-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
        }
        
        .period-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .period-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-range input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .metric-card.blue { border-left-color: #3b82f6; }
        .metric-card.purple { border-left-color: #a855f7; }
        .metric-card.red { border-left-color: #ef4444; }
        .metric-card.green { border-left-color: #10b981; }
        
        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
        }
        
        .metric-change {
            color: #10b981;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .date-display {
            color: #64748b;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.clickable {
            cursor: pointer;
        }
        
        .table-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #64748b;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge.green {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge.yellow {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge.red {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Footer */
        footer {
            margin-top: 30px;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
        }

        .close {
            color: #64748b;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ef4444;
        }

        .modal-chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
        }

        .modal-summary {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Operations KPI Dashboard</h1>
            <p class="subtitle">Warehouse Performance Metrics</p>
        </header>
        
        <div class="upload-section">
            <div class="file-input-wrapper">
                <div class="tooltip">
                    <label for="excelFile" class="upload-btn">üìÅ Load Excel File</label>
                    <span class="tooltiptext">
                        <strong>Excel File Format:</strong><br>
                        <strong>Sheet "Shipments":</strong> Date, TTM, Customer, Boxes Picked, Pallets Picked, ft¬≤<br>
                        <strong>Sheet "Errors":</strong> Date, TTM<br>
                        (Accuracy calculated as: error count / shipment count)
                    </span>
                </div>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            </div>
            <div class="file-info" id="fileInfo">No file loaded. Using sample data.</div>
        </div>
        
        <div class="filter-section">
            <span class="filter-label">View:</span>
            <div class="period-buttons">
                <button class="period-btn active" onclick="setPeriod('daily')">Daily</button>
                <button class="period-btn" onclick="setPeriod('weekly')">Weekly</button>
                <button class="period-btn" onclick="setPeriod('monthly')">Monthly</button>
            </div>
            <span class="filter-label" style="margin-left: 20px;">Date Range:</span>
            <div class="date-range">
                <input type="date" id="startDate" onchange="updateDashboard()">
                <span>to</span>
                <input type="date" id="endDate" onchange="updateDashboard()">
            </div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card blue">
                <div class="metric-label">Total Boxes Picked</div>
                <div class="metric-value" id="totalBoxes">-</div>
                <div class="date-display" id="boxesDateRange"></div>
            </div>
            <div class="metric-card purple">
                <div class="metric-label">Total Pallets</div>
                <div class="metric-value" id="totalPallets">-</div>
                <div class="date-display" id="palletsDateRange"></div>
            </div>
            <div class="metric-card green">
                <div class="metric-label">Total Ft¬≤ Picked</div>
                <div class="metric-value" id="totalSqft">-</div>
                <div class="date-display" id="sqftDateRange"></div>
            </div>
            <div class="metric-card red">
                <div class="metric-label">Error Rate</div>
                <div class="metric-value" id="errorRate">-</div>
                <div class="date-display" id="errorDateRange"></div>
            </div>
            <div class="metric-card blue">
                <div class="metric-label">Avg Accuracy</div>
                <div class="metric-value" id="avgAccuracy">-</div>
                <div class="date-display" id="accuracyDateRange"></div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">üì¶ Boxes Picked by Employee</h3>
                <div class="chart-container">
                    <canvas id="boxesChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">üöö Pallets Picked by Employee</h3>
                <div class="chart-container">
                    <canvas id="palletsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-card" style="margin-bottom: 30px;">
            <h3 class="chart-title">üìè Square Footage Picked by Employee Over Time</h3>
            <div style="position: relative; height: 400px;">
                <canvas id="sqftTrendChart"></canvas>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">üìà Productivity Trend Over Time</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">‚ö†Ô∏è Errors by Employee</h3>
                <div class="chart-container">
                    <canvas id="errorsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="chart-card" style="margin-bottom: 30px;">
            <h3 class="chart-title">üìÖ Average Ft¬≤ Picked by Weekday (Click for Customer Breakdown)</h3>
            <div class="chart-container clickable">
                <canvas id="weekdayChart"></canvas>
            </div>
        </div>
        
        <div class="table-card">
            <h3 class="chart-title">Employee Performance Details</h3>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Boxes</th>
                        <th>Pallets</th>
                        <th>Errors</th>
                        <th>Sq Ft Shipped</th>
                        <th>Accuracy</th>
                        <th>Lines Shipped</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a href="ttm-analytics.html" style="display: inline-block; background: #3b82f6; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s;" onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                üìä View TTM Performance Analytics
            </a>
        </div>

        <footer>
            ¬© 2025 Justin A.F.D. Kozak
        </footer>
    </div>

    <!-- Customer Breakdown Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Customer Breakdown</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-chart-container">
                <canvas id="customerPieChart"></canvas>
            </div>
            <div class="modal-summary" id="modalSummary">
                <!-- Summary will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let allData = [];
        let allErrors = [];
        let currentPeriod = 'daily';
        let customerModalChart = null;
        
        // Sample data with dates
        function generateSampleData() {
            const employees = ['John M.', 'Sarah K.', 'Mike R.', 'Lisa P.', 'David L.', 'Emma W.'];
            const customers = ['Acme Corp', 'Tech Solutions Inc', 'Global Industries', 'MegaMart', 'Supply Chain Co', 'Retail Giant', 'Manufacturing Ltd', 'Distribution Pro', 'Logistics Plus', 'Warehouse Direct', 'Quick Ship', 'Fast Track'];
            const data = [];
            const today = new Date();
            
            // Generate 30 days of data
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                employees.forEach(emp => {
                    // Each employee has multiple shipment lines per day
                    const numShipments = Math.floor(Math.random() * 3) + 2; // 2-4 shipments per day
                    for (let j = 0; j < numShipments; j++) {
                        data.push({
                            date: date.toISOString().split('T')[0],
                            name: emp,
                            customer: customers[Math.floor(Math.random() * customers.length)],
                            boxes: Math.floor(Math.random() * 50) + 50,
                            pallets: Math.floor(Math.random() * 5) + 3,
                            sqft: Math.floor(Math.random() * 500) + 500
                        });
                    }
                });
            }
            return data;
        }
        
        function generateSampleErrors() {
            const employees = ['John M.', 'Sarah K.', 'Mike R.', 'Lisa P.', 'David L.', 'Emma W.'];
            const errors = [];
            const today = new Date();
            
            // Generate 30 days of errors (roughly 2-5% error rate)
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                employees.forEach(emp => {
                    // Random number of errors per day (0-2)
                    const numErrors = Math.random() < 0.7 ? Math.floor(Math.random() * 2) : Math.floor(Math.random() * 3);
                    for (let j = 0; j < numErrors; j++) {
                        errors.push({
                            date: date.toISOString().split('T')[0],
                            name: emp
                        });
                    }
                });
            }
            return errors;
        }
        
        allData = generateSampleData();
        allErrors = generateSampleErrors();
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('fileInfo').textContent = `Loading ${file.name}...`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Debug: Log available sheet names
                    console.log('Available sheets:', workbook.SheetNames);
                    
                    // Look for the "Shipments" sheet specifically
                    const shipmentsSheet = workbook.Sheets['Shipments'];
                    if (!shipmentsSheet) {
                        throw new Error('Sheet "Shipments" not found. Please ensure your Excel file has a sheet named "Shipments". Available sheets: ' + workbook.SheetNames.join(', '));
                    }
                    
                    // Look for the "Errors" sheet
                    const errorsSheet = workbook.Sheets['Errors'];
                    if (!errorsSheet) {
                        throw new Error('Sheet "Errors" not found. Please ensure your Excel file has a sheet named "Errors". Available sheets: ' + workbook.SheetNames.join(', '));
                    }
                    
                    const jsonData = XLSX.utils.sheet_to_json(shipmentsSheet, {range: 1});// Start parsing from the second row (index 1)
                    const errorsData = XLSX.utils.sheet_to_json(errorsSheet, {range: 1});
                    
                    console.log('Raw Shipments data count:', jsonData.length);
                    console.log('Sample row from Excel:', jsonData[0]);
                    console.log('Column names detected:', Object.keys(jsonData[0] || {}));
                    console.log('Raw Errors data count:', errorsData.length);
                    console.log('Sample error row:', errorsData[0]);
                    
                    allData = jsonData.map(row => {
                        let dateValue = row['Date'] || row['date'] || row['DATE'];
                        
                        // Handle Excel date serial numbers
                        if (typeof dateValue === 'number') {
                            const excelEpoch = new Date(1899, 11, 30);
                            const date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                            dateValue = date.toISOString().split('T')[0];
                        } else if (dateValue instanceof Date) {
                            dateValue = dateValue.toISOString().split('T')[0];
                        } else if (typeof dateValue === 'string') {
                            // Try to parse string dates
                            const parsed = new Date(dateValue);
                            if (!isNaN(parsed.getTime())) {
                                dateValue = parsed.toISOString().split('T')[0];
                            }
                        }
                        
                        return {
                            date: dateValue,
                            name: row['TTM'] || row['Employee'] || row['Name'] || row['employee'] || row['name'] || 'Unknown',
                            customer: row['Customer'] || row['customer'] || row['CUSTOMER'] || 'Unknown',
                            boxes: parseInt(row['Boxes Picked'] || row['boxes'] || row['BOXES'] || 0),
                            pallets: parseInt(row['Pallets Picked'] || row['pallets'] || row['PALLETS'] || 0),
                            sqft: parseInt(row['ft¬≤'] || row['sqft'] || row['Square Footage'] || row['SQFT'] || row['Sq Ft'] || 0)
                        };
                    });
                    
                    // Process errors data
                    allErrors = errorsData.map(row => {
                        let dateValue = row['Date'] || row['date'] || row['DATE'];
                        
                        // Handle Excel date serial numbers
                        if (typeof dateValue === 'number') {
                            const excelEpoch = new Date(1899, 11, 30);
                            const date = new Date(excelEpoch.getTime() + dateValue * 86400000);
                            dateValue = date.toISOString().split('T')[0];
                        } else if (dateValue instanceof Date) {
                            dateValue = dateValue.toISOString().split('T')[0];
                        } else if (typeof dateValue === 'string') {
                            const parsed = new Date(dateValue);
                            if (!isNaN(parsed.getTime())) {
                                dateValue = parsed.toISOString().split('T')[0];
                            }
                        }
                        
                        return {
                            date: dateValue,
                            name: row['TTM'] || row['Employee'] || row['Name'] || row['employee'] || row['name'] || 'Unknown'
                        };
                    }).filter(row => row.name.toLowerCase() !== 'ignore');
                    
                    console.log('Processed data sample:', allData[0]);
                    console.log('Total shipment records:', allData.length);
                    console.log('Total error records:', allErrors.length);
                    
                    // Set date range based on data
                    const dates = allData.map(d => d.date).filter(d => d).sort();
                    if (dates.length > 0) {
                        document.getElementById('startDate').value = dates[0];
                        document.getElementById('endDate').value = dates[dates.length - 1];
                    } else {
                        // If no valid dates, clear the date filters
                        document.getElementById('startDate').value = '';
                        document.getElementById('endDate').value = '';
                    }
                    
                    document.getElementById('fileInfo').textContent = `‚úì Loaded ${file.name} - ${allData.length} shipment records, ${allErrors.length} error records`;
                    updateDashboard();
                } catch (error) {
                    const errorMsg = `‚ùå Error: ${error.message}`;
                    document.getElementById('fileInfo').textContent = errorMsg;
                    console.error('Full error:', error);
                    console.error('Error stack:', error.stack);
                    alert('Error loading file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDashboard();
        }
        
        function getFilteredData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Date range - Start:', startDate, 'End:', endDate);
            console.log('All data length:', allData.length);
            
            // If no date filters are set, return all data
            if (!startDate && !endDate) {
                console.log('No date filters - returning all data');
                return allData;
            }
            
            let filtered = allData;
            
            if (startDate) {
                filtered = filtered.filter(d => d.date && d.date >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(d => d.date && d.date <= endDate);
            }
            
            console.log('After filtering:', filtered.length, 'records');
            
            return filtered;
        }
        
        function getFilteredErrors() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // If no date filters are set, return all errors
            if (!startDate && !endDate) {
                return allErrors;
            }
            
            let filtered = allErrors;
            
            if (startDate) {
                filtered = filtered.filter(d => d.date && d.date >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(d => d.date && d.date <= endDate);
            }
            
            return filtered;
        }
        
        function calculateErrorsAndAccuracy(filteredShipments, filteredErrors) {
            console.log('=== calculateErrorsAndAccuracy ===');
            console.log('Filtered shipments:', filteredShipments.length);
            console.log('Filtered errors:', filteredErrors.length);
            
            // Count errors by TTM
            const errorsByTTM = {};
            filteredErrors.forEach(error => {
                if (!errorsByTTM[error.name]) {
                    errorsByTTM[error.name] = 0;
                }
                errorsByTTM[error.name]++;
            });
            
            // Count shipment lines by TTM
            const shipmentsByTTM = {};
            filteredShipments.forEach(shipment => {
                if (!shipmentsByTTM[shipment.name]) {
                    shipmentsByTTM[shipment.name] = 0;
                }
                shipmentsByTTM[shipment.name]++;
            });
            
            // Calculate accuracy for each TTM
            const accuracyByTTM = {};
            Object.keys(shipmentsByTTM).forEach(name => {
                const errorCount = errorsByTTM[name] || 0;
                const shipmentCount = shipmentsByTTM[name] || 1;
                // Accuracy as percentage: (errors / shipments) * 100
                accuracyByTTM[name] = ((errorCount / shipmentCount) * 100).toFixed(2);
            });
            
            console.log('Errors by TTM:', errorsByTTM);
            console.log('Shipments by TTM:', shipmentsByTTM);
            console.log('Accuracy by TTM:', accuracyByTTM);
            
            return {
                errorsByTTM,
                shipmentsByTTM,
                accuracyByTTM
            };
        }
        
        function aggregateByPeriod(data, errorStats) {
            const grouped = {};
            
            data.forEach(row => {
                let key;
                const date = new Date(row.date);
                
                if (currentPeriod === 'daily') {
                    key = `${row.name}-${row.date}`;
                } else if (currentPeriod === 'weekly') {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay());
                    key = `${row.name}-${weekStart.toISOString().split('T')[0]}`;
                } else { // monthly
                    key = `${row.name}-${date.getFullYear()}-${date.getMonth() + 1}`;
                }
                
                if (!grouped[key]) {
                    grouped[key] = {
                        name: row.name,
                        boxes: 0,
                        pallets: 0,
                        sqft: 0,
                        days: 0
                    };
                }
                
                grouped[key].boxes += row.boxes;
                grouped[key].pallets += row.pallets;
                grouped[key].sqft += row.sqft;
                grouped[key].days++;
            });
            
            // Aggregate by employee
            const byEmployee = {};
            Object.values(grouped).forEach(item => {
                if (!byEmployee[item.name]) {
                    byEmployee[item.name] = {
                        name: item.name,
                        boxes: 0,
                        pallets: 0,
                        sqft: 0,
                        days: 0,
                        errors: 0,
                        accuracy: 0,
                        linesShipped: 0
                    };
                }
                byEmployee[item.name].boxes += item.boxes;
                byEmployee[item.name].pallets += item.pallets;
                byEmployee[item.name].sqft += item.sqft;
                byEmployee[item.name].days += item.days;
            });
            
            // Add error counts, accuracy, and shipment counts from errorStats
            Object.keys(byEmployee).forEach(name => {
                byEmployee[name].errors = errorStats.errorsByTTM[name] || 0;
                byEmployee[name].accuracy = parseFloat(errorStats.accuracyByTTM[name]) || 0;
                byEmployee[name].linesShipped = errorStats.shipmentsByTTM[name] || 0;
            });
            
            return Object.values(byEmployee);
        }
        
        function updateDashboard() {
            console.log('=== UPDATE DASHBOARD CALLED ===');
            console.log('allData length:', allData.length);
            console.log('allErrors length:', allErrors.length);
            
            const filteredData = getFilteredData();
            const filteredErrors = getFilteredErrors();
            console.log('Filtered data:', filteredData.length, 'records');
            console.log('Filtered errors:', filteredErrors.length, 'records');
            console.log('Sample filtered record:', filteredData[0]);
            
            if (filteredData.length === 0) {
                console.warn('WARNING: No filtered data available!');
                alert('No data available after filtering. Check your date range or data file.');
                return;
            }
            
            const errorStats = calculateErrorsAndAccuracy(filteredData, filteredErrors);
            const aggregatedData = aggregateByPeriod(filteredData, errorStats);
            console.log('Aggregated data:', aggregatedData.length, 'employees');
            console.log('Sample aggregated record:', aggregatedData[0]);
            
            if (aggregatedData.length === 0) {
                console.warn('WARNING: No aggregated data!');
                alert('No aggregated data available. Check console for details.');
                return;
            }
            
            updateMetrics(aggregatedData, filteredData);
            updateCharts(aggregatedData, filteredData);
            updateTable(aggregatedData);
            console.log('=== DASHBOARD UPDATE COMPLETE ===');
        }
        
        function updateMetrics(data, rawData) {
            const totalBoxes = data.reduce((sum, emp) => sum + emp.boxes, 0);
            const totalPallets = data.reduce((sum, emp) => sum + emp.pallets, 0);
            const totalErrors = data.reduce((sum, emp) => sum + emp.errors, 0);
            const totalSqft = data.reduce((sum, emp) => sum + emp.sqft, 0);
            const totalLinesShipped = data.reduce((sum, emp) => sum + emp.linesShipped, 0);
            const avgAccuracy = (data.reduce((sum, emp) => sum + emp.accuracy, 0) / data.length).toFixed(2);
            const errorRate = totalLinesShipped > 0 ? ((totalErrors / totalLinesShipped) * 100).toFixed(2) : '0.00';
            
            const startDate = document.getElementById('startDate').value || 'All';
            const endDate = document.getElementById('endDate').value || 'All';
            const dateRangeText = `${startDate} to ${endDate}`;
            
            document.getElementById('totalBoxes').textContent = totalBoxes.toLocaleString();
            document.getElementById('totalPallets').textContent = totalPallets.toLocaleString();
            document.getElementById('totalSqft').textContent = totalSqft.toLocaleString();
            document.getElementById('errorRate').textContent = errorRate + '%';
            document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
            
            document.querySelectorAll('.date-display').forEach(el => {
                el.textContent = dateRangeText;
            });
        }
        
        function updateCharts(data, rawData) {
            // Sort data alphabetically by name
            const sortedData = data.sort((a, b) => a.name.localeCompare(b.name));
            const names = sortedData.map(e => e.name);
            const boxes = sortedData.map(e => e.boxes);
            const pallets = sortedData.map(e => e.pallets);
            const errors = sortedData.map(e => e.errors);
            
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart.destroy());
            
            // Boxes Chart
            charts.boxes = new Chart(document.getElementById('boxesChart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Boxes',
                        data: boxes,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Pallets Chart
            charts.pallets = new Chart(document.getElementById('palletsChart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Pallets',
                        data: pallets,
                        backgroundColor: '#a855f7',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Errors Chart
            charts.errors = new Chart(document.getElementById('errorsChart'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Errors',
                        data: errors,
                        backgroundColor: '#ef4444',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Trend Chart - aggregate by date
            const trendData = {};
            rawData.forEach(row => {
                if (!trendData[row.date]) {
                    trendData[row.date] = { boxes: 0, pallets: 0, errors: 0 };
                }
                trendData[row.date].boxes += row.boxes;
                trendData[row.date].pallets += row.pallets;
                trendData[row.date].errors += row.errors;
            });
            
            const sortedDates = Object.keys(trendData).sort();
            const trendBoxes = sortedDates.map(d => trendData[d].boxes);
            const trendPallets = sortedDates.map(d => trendData[d].pallets);
            
            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [
                        {
                            label: 'Boxes',
                            data: trendBoxes,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Pallets',
                            data: trendPallets,
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
            
            // Square Footage Trend by Employee - use filtered data
            const filteredData = getFilteredData();
            const sqftByEmployee = {};
            filteredData.forEach(row => {
                if (!sqftByEmployee[row.name]) {
                    sqftByEmployee[row.name] = {};
                }
                if (!sqftByEmployee[row.name][row.date]) {
                    sqftByEmployee[row.name][row.date] = 0;
                }
                sqftByEmployee[row.name][row.date] += row.sqft;
            });
            
            // Get all unique dates from filtered data and sort them
            const allDatesSet = new Set();
            filteredData.forEach(row => allDatesSet.add(row.date));
            const allDates = Array.from(allDatesSet).sort();
            
            // Sort employee names alphabetically
            const sortedEmployeeNames = Object.keys(sqftByEmployee).sort((a, b) => a.localeCompare(b));
            
            const colors = ['#3b82f6', '#a855f7', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
            const sqftDatasets = sortedEmployeeNames.map((empName, idx) => {
                const empData = sqftByEmployee[empName];
                const dataPoints = allDates.map(date => empData[date] || null);
                
                return {
                    label: empName,
                    data: dataPoints,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '20',
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    spanGaps: true
                };
            });
            
            charts.sqftTrend = new Chart(document.getElementById('sqftTrendChart'), {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: sqftDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true, 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Square Footage'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            // Weekday Average Chart - aggregate by unique dates first
            const dailyTotals = {};
            
            // First, sum up all ft¬≤ for each unique date
            filteredData.forEach(row => {
                if (row.date) {
                    if (!dailyTotals[row.date]) {
                        dailyTotals[row.date] = 0;
                    }
                    dailyTotals[row.date] += row.sqft;
                }
            });
            
            // Then group by weekday
            const weekdayData = {
                'Sunday': { total: 0, count: 0 },
                'Monday': { total: 0, count: 0 },
                'Tuesday': { total: 0, count: 0 },
                'Wednesday': { total: 0, count: 0 },
                'Thursday': { total: 0, count: 0 },
                'Friday': { total: 0, count: 0 },
                'Saturday': { total: 0, count: 0 }
            };
            
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            Object.keys(dailyTotals).forEach(dateStr => {
                // Parse date manually to avoid timezone issues
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const dayName = weekdayNames[date.getDay()];
                weekdayData[dayName].total += dailyTotals[dateStr];
                weekdayData[dayName].count += 1;
            });
            
            const weekdayAverages = weekdayNames.map(day => {
                return weekdayData[day].count > 0 
                    ? Math.round(weekdayData[day].total / weekdayData[day].count)
                    : 0;
            });
            
            charts.weekday = new Chart(document.getElementById('weekdayChart'), {
                type: 'bar',
                data: {
                    labels: weekdayNames,
                    datasets: [{
                        label: 'Average Ft¬≤ Picked',
                        data: weekdayAverages,
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#a855f7', '#ec4899', '#8b5cf6'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const day = weekdayNames[context.dataIndex];
                                    const count = weekdayData[day].count;
                                    return `Avg: ${context.parsed.y.toLocaleString()} ft¬≤ (${count} days) - Click for customer breakdown`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Square Footage'
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const clickedElement = elements[0];
                            const dayName = weekdayNames[clickedElement.index];
                            openModal(dayName);
                        }
                    }
                }
            });
            
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Sort data alphabetically by name
            const sortedData = data.sort((a, b) => a.name.localeCompare(b.name));
            
            sortedData.forEach(emp => {
                const row = tbody.insertRow();
                // Accuracy is now error rate - lower is better
                const accuracyBadge = emp.accuracy <= 3 ? 'green' : emp.accuracy <= 5 ? 'yellow' : 'red';
                row.innerHTML = `
                    <td><strong>${emp.name}</strong></td>
                    <td>${emp.boxes.toLocaleString()}</td>
                    <td>${emp.pallets}</td>
                    <td><span class="badge ${emp.errors <= 2 ? 'green' : emp.errors <= 5 ? 'yellow' : 'red'}">${emp.errors}</span></td>
                    <td>${emp.sqft.toLocaleString()}</td>
                    <td><span class="badge ${accuracyBadge}">${emp.accuracy.toFixed(2)}%</span></td>
                    <td>${emp.linesShipped}</td>
                `;
            });
            
            // Add totals row
            const totalBoxes = sortedData.reduce((sum, emp) => sum + emp.boxes, 0);
            const totalPallets = sortedData.reduce((sum, emp) => sum + emp.pallets, 0);
            const totalErrors = sortedData.reduce((sum, emp) => sum + emp.errors, 0);
            const totalSqft = sortedData.reduce((sum, emp) => sum + emp.sqft, 0);
            const avgAccuracy = (sortedData.reduce((sum, emp) => sum + emp.accuracy, 0) / sortedData.length).toFixed(2);
            const totalLinesShipped = sortedData.reduce((sum, emp) => sum + emp.linesShipped, 0);
            
            const totalRow = tbody.insertRow();
            totalRow.style.background = '#f1f5f9';
            totalRow.style.fontWeight = 'bold';
            totalRow.innerHTML = `
                <td>TOTAL</td>
                <td>${totalBoxes.toLocaleString()}</td>
                <td>${totalPallets}</td>
                <td>${totalErrors}</td>
                <td>${totalSqft.toLocaleString()}</td>
                <td>${avgAccuracy}%</td>
                <td>${totalLinesShipped}</td>
            `;
        }
        
        // Modal functions
        function openModal(dayName) {
            const modal = document.getElementById('customerModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalSummary = document.getElementById('modalSummary');
            
            modalTitle.textContent = `Customer Breakdown - ${dayName}`;
            
            // Calculate customer data for the selected day
            const filteredData = getFilteredData();
            const customerData = {};
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayIndex = weekdayNames.indexOf(dayName);
            
            filteredData.forEach(row => {
                if (row.customer && row.customer !== 'Unknown' && row.date) {
                    const [year, month, day] = row.date.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    if (date.getDay() === dayIndex) {
                        if (!customerData[row.customer]) {
                            customerData[row.customer] = 0;
                        }
                        customerData[row.customer] += row.sqft;
                    }
                }
            });
            
            // Sort customers by volume and get top 14
            const sortedCustomers = Object.keys(customerData)
                .sort((a, b) => customerData[b] - customerData[a]);
            
            const top14Customers = sortedCustomers.slice(0, 14);
            const otherCustomers = sortedCustomers.slice(14);
            
            const totalSqft = Object.values(customerData).reduce((sum, val) => sum + val, 0);
            
            // Calculate "Other" total
            const otherTotal = otherCustomers.reduce((sum, customer) => sum + customerData[customer], 0);
            
            // Create pie chart data
            const pieData = top14Customers.map(customer => ({
                label: customer,
                value: customerData[customer],
                percentage: ((customerData[customer] / totalSqft) * 100).toFixed(1)
            }));
            
            // Add "Other" category if there are additional customers
            if (otherTotal > 0) {
                pieData.push({
                    label: 'Other',
                    value: otherTotal,
                    percentage: ((otherTotal / totalSqft) * 100).toFixed(1)
                });
            }
            
            // Update summary
            const topCustomer = pieData[0];
            const otherCategory = pieData.find(item => item.label === 'Other');
            const individualCustomers = pieData.filter(item => item.label !== 'Other').length;
            
            modalSummary.innerHTML = `
                <strong>Summary for ${dayName}:</strong><br>
                Total ft¬≤: ${totalSqft.toLocaleString()}<br>
                Top Customer: ${topCustomer ? topCustomer.label : 'N/A'} (${topCustomer ? topCustomer.percentage : '0'}%)<br>
                Individual Customers Shown: ${individualCustomers}<br>
                ${otherCategory ? `Other Customers: ${otherCategory.percentage}%` : ''}
            `;
            
            // Create pie chart
            if (customerModalChart) {
                customerModalChart.destroy();
            }
            
            const colors = [
                '#3b82f6', '#a855f7', '#10b981', '#f59e0b', '#ef4444', 
                '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#84cc16',
                '#06b6d4', '#8b5a2b', '#dc2626', '#7c3aed', '#059669',
                '#6b7280'  // Gray color for "Other" category
            ];
            
            customerModalChart = new Chart(document.getElementById('customerPieChart'), {
                type: 'pie',
                data: {
                    labels: pieData.map(item => item.label),
                    datasets: [{
                        data: pieData.map(item => item.value),
                        backgroundColor: colors.slice(0, pieData.length),
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = pieData[context.dataIndex];
                                    return `${item.label}: ${item.value.toLocaleString()} ft¬≤ (${item.percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            const modal = document.getElementById('customerModal');
            modal.style.display = 'none';
            if (customerModalChart) {
                customerModalChart.destroy();
                customerModalChart = null;
            }
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('customerModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize with sample data
        const today = new Date().toISOString().split('T')[0];
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 29);
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        
        updateDashboard();
    </script>
</body>
</html>